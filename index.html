<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrier Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Custom styles if needed, or to ensure Telegram WebApp specific styles */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font as per general guidelines */
            color: var(--tg-theme-text-color, #000000); /* Telegram theme text color */
            background-color: var(--tg-theme-bg-color, #ffffff); /* Telegram theme background color */
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 600px; /* Max width for better readability on larger screens */
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500; /* Medium font weight for labels */
        }
        input[type="text"], input[type="time"], input[type="file"] {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--tg-theme-hint-color, #cbd5e1); /* Border color from theme or fallback */
            border-radius: 0.375rem; /* Rounded corners */
            box-sizing: border-box;
            background-color: var(--tg-theme-secondary-bg-color, #f9fafb); /* Input background */
            color: var(--tg-theme-text-color, #000000);
        }
        input[type="file"] {
            padding: 0.5rem; /* Slightly less padding for file input */
        }
        button {
            width: 100%;
            padding: 0.75rem 1.5rem;
            background-color: var(--tg-theme-button-color, #2563eb); /* Button color from theme or fallback */
            color: var(--tg-theme-button-text-color, #ffffff); /* Button text color from theme or fallback */
            border: none;
            border-radius: 0.375rem;
            font-weight: 600; /* Semi-bold for button text */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            opacity: 0.9;
        }
        .header {
            background-color: var(--tg-theme-secondary-bg-color, #f3f4f6);
            padding: 1rem 0;
            text-align: center;
            border-bottom: 1px solid var(--tg-theme-hint-color, #e5e7eb);
        }
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--tg-theme-text-color, #1f2937);
        }
        .footer {
            text-align: center;
            padding: 1rem;
            margin-top: auto;
            font-size: 0.875rem;
            color: var(--tg-theme-hint-color, #6b7280);
        }
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .container {
                padding: 15px;
            }
            .header h1 {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Carrier Report Form</h1>
    </div>

    <div class="container">
        <form id="reportForm">
            <div>
                <label for="check_in_time">Check-IN Time:</label>
                <input type="time" id="check_in_time" name="check_in_time" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
            </div>

            <div>
                <label for="door_number" class="mt-4">Door #:</label>
                <input type="text" id="door_number" name="door_number" placeholder="e.g., D12 or 105" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
            </div>

            <div>
                <label for="checkout_time" class="mt-4">Check-OUT Time:</label>
                <input type="time" id="checkout_time" name="checkout_time" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
            </div>

            <div>
                <label for="bol_picture" class="mt-4">BOL Picture (max 2MB, will be resized):</label>
                <input type="file" id="bol_picture" name="bol_picture" accept="image/*" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                <img id="imagePreview" src="#" alt="Image Preview" class="mt-2 rounded-lg hidden" style="max-width: 100%; height: auto; max-height: 200px;"/>
            </div>

            <button type="submit" id="submitButton" class="mt-6 w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                Submit Report
            </button>
        </form>
    </div>

    <div class="footer">
        <p id="statusMessage"></p>
        <p>&copy; <span id="currentYear"></span> Carrier Bot</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;

        document.addEventListener('DOMContentLoaded', function () {
            tg.ready();
            tg.expand(); 

            const form = document.getElementById('reportForm');
            const submitButton = document.getElementById('submitButton');
            const statusMessage = document.getElementById('statusMessage');
            const imagePreview = document.getElementById('imagePreview');
            const bolPictureInput = document.getElementById('bol_picture');
            
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            bolPictureInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) { // Check file size (e.g., 2MB limit for initial check)
                        statusMessage.textContent = 'Image is too large (max 2MB). Please choose a smaller file.';
                        bolPictureInput.value = ""; // Clear the input
                        imagePreview.src = "#";
                        imagePreview.classList.add('hidden');
                        return;
                    }
                    statusMessage.textContent = ''; // Clear previous error
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.src = "#";
                    imagePreview.classList.add('hidden');
                }
            });

            form.addEventListener('submit', async function (event) {
                event.preventDefault();
                statusMessage.textContent = 'Submitting...';
                submitButton.disabled = true;
                tg.MainButton.showProgress(false);


                const checkInTime = document.getElementById('check_in_time').value;
                const doorNumber = document.getElementById('door_number').value;
                const checkoutTime = document.getElementById('checkout_time').value;
                const bolPictureFile = bolPictureInput.files[0];

                let photoDataBase64 = null;
                if (bolPictureFile) {
                    try {
                        // Resize image before converting to Base64
                        photoDataBase64 = await resizeImageAndToB64(bolPictureFile, 800, 0.7); // Max width/height 800px, quality 0.7
                        console.log("Resized photo Base64 length:", photoDataBase64 ? photoDataBase64.length : 0);
                    } catch (error) {
                        console.error("Error resizing or converting image to Base64:", error);
                        statusMessage.textContent = 'Error processing image. Please try again.';
                        submitButton.disabled = false;
                        tg.MainButton.hideProgress();
                        return;
                    }
                }

                const reportData = {
                    check_in_time: checkInTime,
                    door_number: doorNumber,
                    checkout_time: checkoutTime,
                    photo_data_base64: photoDataBase64 
                };

                console.log("Data to be sent (length):", JSON.stringify(reportData).length, reportData);
                
                if (JSON.stringify(reportData).length > 4000) { // A bit less than 4096 for safety
                     console.warn("Data is still too long after resize attempt. Photo might be very complex or not resizing enough.");
                     statusMessage.textContent = 'Report data is too large, even after image processing. Try a smaller image.';
                     submitButton.disabled = false;
                     tg.MainButton.hideProgress();
                     return;
                }

                try {
                    tg.sendData(JSON.stringify(reportData));
                    statusMessage.textContent = 'Report submitted! You can close this window.';
                    // tg.close(); // Optionally close after successful submission
                } catch (error) {
                    console.error("Error sending data via tg.sendData:", error);
                    statusMessage.textContent = 'Error submitting report. Please try again. Details: ' + error.message;
                    submitButton.disabled = false;
                } finally {
                    tg.MainButton.hideProgress();
                }
            });
             // Configure MainButton for submission
            tg.MainButton.setText('Submit Report');
            tg.MainButton.onClick(function() {
                form.requestSubmit(); // Trigger form submission when MainButton is clicked
            });
            // Show MainButton if all required fields are filled (basic example)
            // More robust validation can be added
            form.addEventListener('input', function() {
                if (form.checkValidity()) {
                    tg.MainButton.show();
                } else {
                    tg.MainButton.hide();
                }
            });
            // Initial check
            if (form.checkValidity()) {
                 tg.MainButton.show();
            } else {
                 tg.MainButton.hide();
            }

        });

        // Function to resize image and convert to Base64
        function resizeImageAndToB64(file, maxWidthOrHeight, quality) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidthOrHeight) {
                                height *= maxWidthOrHeight / width;
                                width = maxWidthOrHeight;
                            }
                        } else {
                            if (height > maxWidthOrHeight) {
                                width *= maxWidthOrHeight / height;
                                height = maxWidthOrHeight;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality)); // Use image/jpeg for better compression
                    };
                    img.onerror = (error) => {
                        reject(error);
                    };
                };
                reader.onerror = (error) => {
                    reject(error);
                };
            });
        }
    </script>
</body>
</html>
